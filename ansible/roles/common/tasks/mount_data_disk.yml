---
- name: Map serial to device for {{ data_disk.name }}
  ansible.builtin.set_fact:
    common_current_dev_node: "{{ item.key }}"
  when:
    - item.value.serial is defined
    - item.value.serial == data_disk.name
  loop: "{{ ansible_facts.get('devices', {}) | dict2items }}"
  loop_control:
    label: "/dev/{{ item.key }}"

- name: Format and mount {{ data_disk.name }}
  when: common_current_dev_node is defined
  block:
    - name: Create filesystem on /dev/{{ common_current_dev_node }}
      community.general.filesystem:
        fstype: ext4
        dev: "/dev/{{ common_current_dev_node }}"
        force: false

    - name: Get UUID for fstab
      ansible.builtin.command: "blkid -s UUID -o value /dev/{{ common_current_dev_node }}"
      register: common_disk_uuid
      changed_when: false

    - name: Mount disk to /var/storage/{{ data_disk.tier }}
      ansible.posix.mount:
        path: "/var/storage/{{ data_disk.tier }}"
        src: "UUID={{ common_disk_uuid.stdout }}"
        fstype: ext4
        opts: defaults
        state: mounted

- name: Clear common_current_dev_node for next iteration
  ansible.builtin.set_fact:
    common_current_dev_node: null
